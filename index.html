<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Produtos NF-e com Tributos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered main-title">
                <i class="fas fa-file-invoice"></i> Gest√£o de Produtos NF-e com Tributos
            </h1>

            <!-- Upload Section -->
            <div class="box no-print">
                <div class="box-header">
                    <h2 class="subtitle">
                        <i class="fas fa-upload"></i> Upload de NF-e XML
                    </h2>
                </div>
                
                <!-- Toggle Tributos 2026 -->
                <div class="field" style="margin-bottom: 1rem;">
                    <div class="control">
                        <label class="checkbox" style="display: flex; align-items: center; gap: 10px; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <input type="checkbox" id="tributos2026Toggle" onchange="toggleTributos2026()">
                            <span style="font-weight: 600; color: #1e40af;">
                                <i class="fas fa-landmark"></i> Aplicar Tributos 2026 (Reforma Tribut√°ria)
                            </span>
                        </label>
                        <p class="help" id="tributosHelp" style="margin-top: 0.5rem; margin-left: 1rem; color: #666;">
                            <strong>Modo Atual:</strong> Extrai ICMS, IPI, PIS, COFINS da NF-e | 
                            <strong>Modo 2026:</strong> IBS (26,5%) + CBS calculados automaticamente
                        </p>
                    </div>
                </div>
                
                <!-- Toggle Sem Tributos -->
                <div class="field" style="margin-bottom: 1rem;">
                    <div class="control">
                        <label class="checkbox" style="display: flex; align-items: center; gap: 10px; padding: 1rem; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <input type="checkbox" id="semTributosToggle" onchange="toggleSemTributos()">
                            <span style="font-weight: 600; color: #991b1b;">
                                <i class="fas fa-ban"></i> Trabalhar SEM Tributos (Custo Base com Tributo = Custo Base)
                            </span>
                        </label>
                        <p class="help" id="semTributosHelp" style="margin-top: 0.5rem; margin-left: 1rem; color: #666;">
                            <strong>Sem Tributos:</strong> Desativa c√°lculo de tributos (Custo Base com Tributo = Custo Base)
                        </p>
                    </div>
                </div>
                
                <div class="file has-name is-fullwidth">
                    <label class="file-label">
                        <input class="file-input" type="file" id="xmlFile" accept=".xml" multiple>
                        <span class="file-cta">
                            <span class="file-icon">
                                <i class="fas fa-upload"></i>
                            </span>
                            <span class="file-label">
                                Selecionar XML(s)...
                            </span>
                        </span>
                        <span class="file-name" id="fileName">
                            Nenhum arquivo selecionado
                        </span>
                    </label>
                </div>
                <div class="notification is-info is-light mt-3">
                    <i class="fas fa-info-circle"></i> Selecione um ou mais arquivos XML de NF-e para extrair os produtos E tributos automaticamente.
                </div>
                <div class="notification is-light mt-2" style="background-color: #fef3c7; border-left: 4px solid #f59e0b; color: #92400e;">
                    <i class="fas fa-bolt"></i> <strong>C√°lculos Autom√°ticos:</strong> Digite o Pre√ßo de Venda, Markup ou Margem e veja os outros valores atualizarem em tempo real! 
                    <br>
                    <i class="fas fa-landmark"></i> <strong>Tributos:</strong> O sistema extrai ICMS, IPI, PIS e COFINS da NF-e. Ative o modo 2026 para simular IBS (26,5%) + CBS!
                    <br>
                    <i class="fas fa-calculator"></i> <strong>Custo Base com Tributo:</strong> Calculado automaticamente = Custo Base + Tributos
                    <br>
                    <i class="fas fa-calculator"></i> <strong>Subtotal:</strong> Calculado automaticamente = Custo Base com Tributo √ó Qtd/Embalagem
                    <br>
                    <i class="fas fa-box"></i> <strong>Embalagens:</strong> Use "Qtd/Emb" para produtos que v√™m em caixas. Ex: 1 CX de 500 parafusos por R$ 50,00 = R$ 0,10 unit√°rio.
                    <br>
                    <i class="fas fa-barcode"></i> <strong>Etiquetas:</strong> As etiquetas mostram a descri√ß√£o, unidade e c√≥digo de barras EAN-13. Use o Preview!
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="box no-print">
                <div class="buttons is-centered">
                    <button class="button is-success" onclick="addProduct()">
                        <span class="icon"><i class="fas fa-plus"></i></span>
                        <span>Adicionar Produto</span>
                    </button>
                    <button class="button is-danger" onclick="deleteSelected()">
                        <span class="icon"><i class="fas fa-trash"></i></span>
                        <span>Excluir Selecionados</span>
                    </button>
                    <button class="button is-link" onclick="exportToExcel()">
                        <span class="icon"><i class="fas fa-file-excel"></i></span>
                        <span>Exportar Excel</span>
                    </button>
                    <button class="button is-link" onclick="exportToCSV()">
                        <span class="icon"><i class="fas fa-file-csv"></i></span>
                        <span>Exportar CSV</span>
                    </button>
                    <button class="button is-info" onclick="importFile()">
                        <span class="icon"><i class="fas fa-file-import"></i></span>
                        <span>Importar</span>
                    </button>
                    <button class="button is-warning" onclick="openPrintModal()">
                        <span class="icon"><i class="fas fa-print"></i></span>
                        <span>Imprimir</span>
                    </button>
                </div>
            </div>

            <!-- Products Table -->
            <div class="table-container">
                <table class="table is-fullwidth is-striped is-hoverable product-table">
                    <thead>
                        <tr>
                            <th class="no-print"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                            <th title="Descri√ß√£o completa do produto">Descri√ß√£o</th>
                            <th title="Nomenclatura Comum do Mercosul">NCM</th>
                            <th title="Unidade de medida (UN, CX, KG, etc)">Unidade</th>
                            <th title="Quantidade de unidades por embalagem">Qtd/Emb</th>
                            <th title="Valor base do produto sem tributos">Custo Base</th>
                            <th title="Soma de todos os tributos (ICMS+IPI+PIS+COFINS ou IBS+CBS)">Tributos</th>
                            <th title="Custo base + tributos = custo real unit√°rio do produto">Custo Base com Tributo</th>
                            <th title="Custo Base com Tributo √ó Qtd/Embalagem = valor total da embalagem">Subtotal</th>
                            <th title="üí° Digite aqui e veja Markup/Margem atualizarem automaticamente!" style="position: relative;">
                                Pre√ßo Venda
                                <span style="color: #fbbf24; font-size: 1.1em; margin-left: 3px;">‚ö°</span>
                            </th>
                            <th title="üí° Digite o Markup desejado e o Pre√ßo ser√° calculado automaticamente!">
                                Markup (%)
                                <span style="color: #fbbf24; font-size: 1.1em; margin-left: 3px;">‚ö°</span>
                            </th>
                            <th title="üí° Digite a Margem desejada e o Pre√ßo ser√° calculado automaticamente!">
                                Margem (%)
                                <span style="color: #fbbf24; font-size: 1.1em; margin-left: 3px;">‚ö°</span>
                            </th>
                            <th title="C√≥digo de Barras EAN-13">C√≥digo EAN-13</th>
                            <th title="Visualiza√ß√£o do c√≥digo de barras">C√≥digo de Barras</th>
                            <th class="no-print">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <!-- Products will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <div id="noProducts" class="notification is-warning has-text-centered" style="display: none;">
                <i class="fas fa-box-open"></i> Nenhum produto cadastrado. Fa√ßa upload de um XML ou adicione produtos manualmente.
            </div>

            <!-- Footer Stats -->
            <div class="box no-print" id="statsBox" style="display: none;">
                <div class="box-header">
                    <h2 class="subtitle">
                        <i class="fas fa-chart-line"></i> Estat√≠sticas e Totalizadores
                    </h2>
                </div>
                
                <div class="columns is-multiline is-mobile">
                    <div class="column is-6-mobile is-3-tablet">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                <i class="fas fa-dollar-sign"></i> Custo Base c/ Tributo
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">
                                R$ <span id="totalCost">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column is-6-mobile is-3-tablet">
                        <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                <i class="fas fa-calculator"></i> Subtotal Geral
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">
                                R$ <span id="totalSubtotal">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column is-6-mobile is-3-tablet">
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                <i class="fas fa-money-bill-wave"></i> Faturamento Total
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">
                                R$ <span id="totalRevenue">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column is-6-mobile is-3-tablet">
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                <i class="fas fa-chart-pie"></i> Margem M√©dia
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">
                                <span id="avgMargin">0.00</span>%
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tributos Totais -->
                <div class="columns is-mobile mt-2">
                    <div class="column">
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                <i class="fas fa-landmark"></i> Total de Tributos <span id="tributosModeBadge" class="tributos-badge tributos-atual">Atual</span>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">
                                R$ <span id="totalTributos">0.00</span>
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;" id="tributosBreakdown">
                                <!-- Breakdown will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="columns is-mobile mt-3">
                    <div class="column">
                        <div class="stat-card" id="profitCard" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.9rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                <i class="fas fa-trophy" id="profitIcon"></i> <span id="profitLabel">Lucro Total Estimado</span>
                            </div>
                            <div style="font-size: 2rem; font-weight: 700;">
                                R$ <span id="totalProfit">0.00</span>
                            </div>
                            <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;" id="profitPercentage">
                                <!-- Percentage will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns is-mobile has-text-centered mt-2">
                    <div class="column">
                        <div class="stat-badge success">
                            <i class="fas fa-box"></i> <strong id="totalProducts">0</strong> Produtos
                        </div>
                    </div>
                    <div class="column">
                        <div class="stat-badge" style="background: #dbeafe; color: #1e40af;">
                            <i class="fas fa-check-circle"></i> <strong id="totalWithEAN">0</strong> com EAN
                        </div>
                    </div>
                    <div class="column">
                        <div class="stat-badge" style="background: #fef3c7; color: #92400e;">
                            <i class="fas fa-exclamation-triangle"></i> <strong id="totalWithoutEAN">0</strong> sem EAN
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal de Op√ß√µes de Impress√£o -->
    <div class="modal" id="printModal">
        <div class="modal-background" onclick="closePrintModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <p class="modal-card-title" style="color: white;">
                    <i class="fas fa-print"></i> Op√ß√µes de Impress√£o
                </p>
                <button class="delete" aria-label="close" onclick="closePrintModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="notification is-info is-light">
                    <i class="fas fa-info-circle"></i> <strong>Selecione o formato de impress√£o desejado</strong>
                </div>
                <div class="notification is-warning is-light">
                    <i class="fas fa-eye"></i> <strong>Importante:</strong> Para etiquetas, clique em "Etiquetas de Pre√ßo" para ver o PREVIEW antes de imprimir! 
                    <br><br>
                    <div style="font-family: monospace; background: #f9fafb; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê<br>
                    ‚îÇ Descri√ß√£o - UNIDADE     ‚îÇ ‚Üê 9pt, negrito<br>
                    ‚îÇ R$ 99,99               ‚îÇ ‚Üê 14pt, destaque<br>
                    ‚îÇ   ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó    ‚îÇ<br>
                    ‚îÇ   ‚ïë|||||||||||||||‚ïë    ‚îÇ ‚Üê C√≥digo EAN-13<br>
                    ‚îÇ   ‚ïë 1234567890123 ‚ïë    ‚îÇ ‚Üê Centralizado<br>
                    ‚îÇ   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚îÇ<br>
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò<br>
                       ‚Üë Borda preta 3px
                    </div>
                    ‚úì Altura: 33mm (otimizada para c√≥digo de barras)<br>
                    ‚úì C√≥digo de barras SEMPRE dentro da borda<br>
                    ‚úì Descri√ß√£o limitada a 2 linhas<br>
                    ‚úì Layout 2 colunas - 18 etiquetas por p√°gina A4
                </div>
                <div class="columns">
                    <div class="column">
                        <div class="box print-option" onclick="printNormal()" style="cursor: pointer; text-align: center; transition: all 0.3s ease; height: 100%;">
                            <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <h3 class="title is-5">Impress√£o Padr√£o</h3>
                            <p>Tabela completa com todos os dados dos produtos em formato A4</p>
                            <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                                <i class="fas fa-check"></i> Todos os campos<br>
                                <i class="fas fa-check"></i> Formato landscape
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="box print-option" onclick="previewLabels()" style="cursor: pointer; text-align: center; transition: all 0.3s ease; height: 100%; border: 2px solid #10b981;">
                            <div style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;">
                                <i class="fas fa-tags"></i>
                            </div>
                            <h3 class="title is-5" style="color: #10b981;">Etiquetas de Pre√ßo</h3>
                            <p>18 etiquetas por p√°gina com descri√ß√£o, pre√ßo e c√≥digo de barras centralizado</p>
                            <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                                <i class="fas fa-check"></i> Layout 2 colunas<br>
                                <i class="fas fa-check"></i> 18 etiquetas/p√°gina (33mm altura)<br>
                                <i class="fas fa-eye" style="color: #10b981;"></i> <strong>Com Preview!</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal de Preview de Etiquetas -->
    <div class="modal" id="previewModal">
        <div class="modal-background" onclick="closePreviewModal()"></div>
        <div class="modal-card" style="max-width: 800px; width: 95%;">
            <header class="modal-card-head" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                <p class="modal-card-title" style="color: white;">
                    <i class="fas fa-eye"></i> Preview de Etiquetas
                </p>
                <button class="delete" aria-label="close" onclick="closePreviewModal()"></button>
            </header>
            <section class="modal-card-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="notification is-success is-light" style="margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i> <strong>Preview das Etiquetas</strong>
                    <br>
                    ‚úì Bordas pretas vis√≠veis em cada etiqueta<br>
                    ‚úì Descri√ß√£o completa do produto + unidade<br>
                    ‚úì Pre√ßo de venda destacado<br>
                    ‚úì C√≥digo de barras EAN-13 (quando dispon√≠vel)<br>
                    <br>
                    <small>Se tudo estiver correto, clique em "Confirmar e Imprimir" abaixo.</small>
                </div>
                <div id="previewContent"></div>
            </section>
            <footer class="modal-card-foot" style="justify-content: center;">
                <button class="button is-success is-large" onclick="confirmPrintLabels()">
                    <span class="icon"><i class="fas fa-print"></i></span>
                    <span>Confirmar e Imprimir</span>
                </button>
                <button class="button is-light is-large" onclick="closePreviewModal()">
                    <span>Cancelar</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- √Årea de Impress√£o de Etiquetas (oculta) -->
    <div id="labelsPrintArea" style="display: none;">
        <!-- Etiquetas ser√£o geradas aqui dinamicamente -->
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleImport(event)">

    <script src="./script.js"></script>
</body>
</html>